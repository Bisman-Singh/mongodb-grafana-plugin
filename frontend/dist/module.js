define(["@grafana/data","@grafana/runtime","rxjs","react","@grafana/ui"],((e,t,n,r,o)=>(()=>{"use strict";var a={781:t=>{t.exports=e},531:e=>{e.exports=t},7:e=>{e.exports=o},959:e=>{e.exports=r},269:e=>{e.exports=n}},i={};function l(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return a[e](n,n.exports,l),n.exports}l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var c={};l.r(c),l.d(c,{plugin:()=>q});var u,s=l(781),d=l(531);!function(e){e.table="table",e.timeserie="timeserie"}(u||(u={}));var b=l(269);function p(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function y(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){p(a,r,o,i,l,"next",e)}function l(e){p(a,r,o,i,l,"throw",e)}i(void 0)}))}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){f(e,t,n[t])}))}return e}function m(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class v extends s.DataSourceApi{getDefaultQuery(e){return{collection:"",queryText:"",queryType:u.timeserie}}filterQuery(e){return!!e.queryText}query(e){var t=this;return y((function*(){try{const{targets:n}=e,r=m(g({},e),{targets:n.map((e=>m(g({},e),{queryText:`{collection: "${e.collection}", aggregations: ${e.queryText}}`}))),db:g({},t.db)});return{data:(yield t.request("/query",r)).data}}catch(e){var n;return{data:[],error:{message:null!==(n=null==e?void 0:e.message)&&void 0!==n?n:e}}}}))()}request(e,t){var n=this;return y((function*(){const r=(0,d.getBackendSrv)().fetch({url:`${n.baseUrl}${e}`,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(t)});return(0,b.lastValueFrom)(r)}))()}testDatasource(){var e=this;return y((function*(){try{const n=yield e.request("/",{db:e.db});return 200===n.status?{status:"success",message:"Success"}:{status:"error",message:null!==(t=n.data.message)&&void 0!==t?t:"unknown"};var t}catch(e){var n;return{status:"error",message:null!==(n=null==e?void 0:e.message)&&void 0!==n?n:e}}}))()}constructor(e){super(e),f(this,"baseUrl",void 0),f(this,"db",void 0),this.baseUrl=e.jsonData.backendUri,this.db={url:e.jsonData.mongoConnString,db:e.jsonData.databaseName}}}var O=l(959),h=l.n(O),j=l(7);function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){P(e,t,n[t])}))}return e}function S(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function E(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function D(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){D(e,t,n[t])}))}return e}function k(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const q=new s.DataSourcePlugin(v).setConfigEditor((function(e){var t,n,r;const{onOptionsChange:o,options:a}=e,i=(e,t)=>{const n=S(w({},a.jsonData),{[t]:e.target.value});o(S(w({},a),{jsonData:n}))};return h().createElement(h().Fragment,null,h().createElement(j.InlineField,{label:"mongodb connection string",labelWidth:30,interactive:!0,tooltip:"mongodb connection string"},h().createElement(j.Input,{required:!0,id:"config-editor-api-key",value:null===(t=a.jsonData)||void 0===t?void 0:t.mongoConnString,placeholder:"mongodb+srv://[username:password@]host[/[defaultauthdb][?options]]",width:40,onReset:()=>{},onChange:e=>i(e,"mongoConnString")})),h().createElement(j.InlineField,{label:"mongodb database name",labelWidth:30,interactive:!0,tooltip:"mongodb database name"},h().createElement(j.Input,{required:!0,id:"config-editor-api-key",value:null===(n=a.jsonData)||void 0===n?void 0:n.databaseName,placeholder:"dbname",width:40,onReset:()=>{},onChange:e=>i(e,"databaseName")})),h().createElement(j.InlineField,{label:"backend url",labelWidth:30,interactive:!0,tooltip:"mongodb plugin backend url"},h().createElement(j.Input,{required:!0,id:"config-editor-api-key",value:null===(r=a.jsonData)||void 0===r?void 0:r.backendUri,placeholder:"http://localhost:4000",width:40,onReset:()=>{},onChange:e=>i(e,"backendUri")})))})).setQueryEditor((function(e){const{query:t,datasource:{baseUrl:n,db:r},onChange:o,onRunQuery:a}=e,{collection:i,queryText:l,queryType:c}=t,[s,p]=h().useState([]),[y,f]=h().useState(!0),[g,m]=h().useState("");h().useEffect((()=>{var e;r&&n&&(e=function*(){try{const e=yield(0,d.getBackendSrv)().fetch({url:`${n}/collections`,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(r)}),a=(yield(0,b.lastValueFrom)(e)).data;!i&&a.length>0&&o(k(x({},t),{collection:a[0]})),p(a),f(!1)}catch(t){var e;m(null!==(e=null==t?void 0:t.message)&&void 0!==e?e:t)}},function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){E(a,r,o,i,l,"next",e)}function l(e){E(a,r,o,i,l,"throw",e)}i(void 0)}))})()}),[r,n]);const v=h().createElement(j.Stack,{gap:0,direction:"column"},h().createElement(j.InlineField,{label:"Type",labelWidth:20},h().createElement(j.Select,{width:20,options:[{label:u.table,value:u.table},{label:u.timeserie,value:u.timeserie}],value:c,onChange:e=>o(k(x({},t),{queryType:e.value}))})),h().createElement(j.InlineField,{label:"Collection Name",labelWidth:20},h().createElement(j.Select,{width:50,options:s.map((e=>({label:e,value:e}))),value:i,onChange:e=>o(k(x({},t),{collection:e.value}))})),h().createElement(j.InlineField,{label:"Aggregation Pipeline",labelWidth:20},h().createElement(j.TextArea,{style:{width:500,minHeight:200},value:null!=l?l:"",placeholder:'[\n    {\n      string: "string",\n      date: new Date(),\n      id: new ObjectId("573a1393f29313caabcdc50e"),\n      bool: true,\n      float: 12345.4,\n      expandable1: $from,\n      expandable2: $to,\n      expandable3: $intervalMs\n    }\n    {\n      ...more stages\n    }\n  ]',onChange:e=>{o(k(x({},t),{queryText:e.currentTarget.value}))},onBlur:e=>{o(k(x({},t),{queryText:e.target.value})),a()}}))),O=h().createElement(j.Stack,{gap:0,direction:"column"},h().createElement(j.Spinner,null),h().createElement(j.Modal,{title:"error",isOpen:!!g},g,h().createElement(j.Modal.ButtonRow,null,h().createElement(j.Button,{onClick:()=>m("")},"Ok"))));return y?O:v}));return c})()));
//# sourceMappingURL=module.js.map